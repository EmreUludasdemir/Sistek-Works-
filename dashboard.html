<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .border-thick { border-width: 3px !important; }
        .status-badge { padding: 0.3em 1em; border-radius: 1em; color: #fff; font-weight: bold; }
        .status-active { background: #198754; }
        .status-inactive { background: #dc3545; }
        .status-run { background: #198754; }
        .status-stop { background: #dc3545; }

        .stat-chip {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: .35rem .6rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: .9rem;
        }
        .table-sm tr td, .table-sm tr th { padding-top:.35rem; padding-bottom:.35rem; }
        .text-0 { color:#adb5bd !important; } /* 0 değerli saatler için */
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <!-- ÜST BLOK: PLC + LINES -->
    <div class="row g-4">
        <!-- PLC Card -->
        <div class="col-12 col-xl-5">
            <div class="card border-thick shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">PLC</h3>
                    <div id="plc-loading">Yükleniyor...</div>
                    <div id="plc-error" class="text-danger d-none"></div>
                    <div id="plc-info" class="d-none">
                        <div>IP: <span id="plc-ip"></span></div>
                        <div>Status: <span id="plc-status" class="status-badge"></span></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Lines Table -->
        <div class="col-12 col-xl-7">
            <div class="card border-thick shadow-sm">
                <div class="card-body">
                    <div id="lines-loading">Yükleniyor...</div>
                    <div id="lines-error" class="text-danger d-none"></div>
                    <div id="lines-table" class="row g-3 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- BLOK: TARİH SEÇ + GÜNLÜK TABLO -->
    <div class="row g-4 mt-2">
        <!-- Sol: Tarih seçme alanı -->
        <div class="col-12 col-md-4">
            <div class="card border-thick shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Tarih Seç</h5>
                    <input type="date" id="date-input" class="form-control" aria-label="Tarih seçici">
                    <div class="form-text mt-2">Gün seçince alttaki raporlar güncellenir.</div>
                </div>
            </div>
        </div>

        <!-- Sağ: Seçilen günde line bazında adet + toplam -->
        <div class="col-12 col-md-8">
            <div class="card border-thick shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Seçilen Günde Barkod Sayıları</h5>

                    <div id="daily-loading">Yükleniyor...</div>
                    <div id="daily-error" class="text-danger d-none"></div>

                    <div id="daily-wrap" class="d-none">
                        <!-- Toplam -->
                        <div class="mb-3">
                            <span class="fw-bold">Toplam:</span>
                            <span id="daily-total" class="fs-4">-</span>
                        </div>

                        <!-- Line tablosu -->
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                <tr>
                                    <th style="width: 50%;">Line</th>
                                    <th class="text-end">Barkod (günlük)</th>
                                </tr>
                                </thead>
                                <tbody id="daily-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- SAATLİK ORTALAMA (TABLO + GRAFİK) -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card border-thick shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <h5 class="card-title mb-0">Seçilen Günde Saatlik Ortalama Barkod</h5>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="stat-chip"><span id="kpi-peak-hour">—</span></div>
                            <div class="stat-chip">Ort/saat: <span id="kpi-avg-hour" class="ms-1">—</span></div>
                            <div class="stat-chip">Gün Toplam: <span id="kpi-total" class="ms-1">—</span></div>
                            <select id="hourly-mode" class="form-select form-select-sm">
                                <option value="count" selected>Toplam (saatlik)</option>
                                <option value="perMinute">Dakika Başına Ortalama</option>
                            </select>
                            <button id="hourly-download" class="btn btn-sm btn-outline-secondary">CSV indir</button>
                        </div>
                    </div>

                    <div id="hourly-loading" class="mt-3">Yükleniyor...</div>
                    <div id="hourly-error" class="text-danger d-none mt-3"></div>

                    <div id="hourly-wrap" class="d-none mt-3">
                        <div class="row">
                            <div class="col-12 col-lg-6">
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle">
                                        <thead>
                                        <tr>
                                            <th style="width: 30%;">Saat</th>
                                            <th class="text-end"><span id="hourly-col-title">Ortalama (saatlik)</span></th>
                                        </tr>
                                        </thead>
                                        <tbody id="hourly-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div style="height: 280px;">
                                    <canvas id="hourly-chart"></canvas>
                                </div>
                                <div class="form-text text-end">Boş saatler 0 gösterilir</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const REFRESH_MS = 5000;

    /* -------------------- MEVCUT İŞLEVLER -------------------- */
    function fetchPlcInfo() {
        fetch('/api/plc/info')
            .then(r => r.json())
            .then(data => {
                document.getElementById('plc-loading').classList.add('d-none');
                document.getElementById('plc-error').classList.add('d-none');
                document.getElementById('plc-info').classList.remove('d-none');
                document.getElementById('plc-ip').textContent = data.plcIp || '-';
                const statusEl = document.getElementById('plc-status');
                statusEl.textContent = data.status || '-';
                statusEl.className = 'status-badge ' + (data.status === 'Active' ? 'status-active' : 'status-inactive');
            })
            .catch(() => {
                document.getElementById('plc-loading').classList.add('d-none');
                document.getElementById('plc-info').classList.add('d-none');
                document.getElementById('plc-error').classList.remove('d-none');
                document.getElementById('plc-error').textContent = 'PLC verisi alınamadı.';
            });
    }

    function fetchLinesOverview() {
        fetch(`/api/lines/overview`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('lines-loading').classList.add('d-none');
                document.getElementById('lines-error').classList.add('d-none');
                const table = document.getElementById('lines-table');
                table.classList.remove('d-none');
                table.innerHTML = '';
                if (!data || data.length === 0) {
                    table.innerHTML = '<div class="col">Veri yok</div>';
                    return;
                }
                data.slice(0,5).forEach(line => {
                    const statusClass = line.status === 'RUN' ? 'status-run' : 'status-stop';
                    table.innerHTML += `
            <div class="col">
              <div class="border-thick rounded p-3 text-center">
                <div class="fw-bold mb-2">${line.lineName}</div>
                <div class="status-badge ${statusClass} mb-2">${line.status}</div>
                <div>${line.barcodeCount} barcode</div>
              </div>
            </div>`;
                });
            })
            .catch(() => {
                document.getElementById('lines-loading').classList.add('d-none');
                document.getElementById('lines-table').classList.add('d-none');
                document.getElementById('lines-error').classList.remove('d-none');
                document.getElementById('lines-error').textContent = 'Lines verisi alınamadı.';
            });
    }

    /* -------------------- GÜNLÜK TABLO -------------------- */
    function toYMD(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function loadDaily(dateStr) {
        const loading = document.getElementById('daily-loading');
        const errorEl = document.getElementById('daily-error');
        const wrap = document.getElementById('daily-wrap');
        const tbody = document.getElementById('daily-tbody');
        const totalSpan = document.getElementById('daily-total');

        loading.classList.remove('d-none');
        errorEl.classList.add('d-none');
        wrap.classList.add('d-none');
        tbody.innerHTML = '';
        totalSpan.textContent = '-';

        const totalReq = fetch(`/api/stats/daily-total?date=${encodeURIComponent(dateStr)}`).then(r => r.json());
        const perLineReq = fetch(`/api/stats/daily-per-line?date=${encodeURIComponent(dateStr)}`).then(r => r.json());

        Promise.all([totalReq, perLineReq])
            .then(([totalData, list]) => {
                totalSpan.textContent = totalData?.total ?? 0;

                if (Array.isArray(list) && list.length) {
                    list.forEach(item => {
                        const name = item.lineCode || item.lineName || `Line-${item.lineId}`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td>${name}</td>
              <td class="text-end fw-semibold">${item.count}</td>`;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="2" class="text-muted">Kayıt yok.</td></tr>`;
                }

                loading.classList.add('d-none');
                wrap.classList.remove('d-none');
            })
            .catch(err => {
                console.error(err);
                loading.classList.add('d-none');
                errorEl.classList.remove('d-none');
                errorEl.textContent = 'Günlük veri alınamadı.';
            });
    }

    /* -------------------- SAATLİK RAPOR -------------------- */
    let hourlyChartInstance = null;
    let lastHourlyRows = [];

    function getHourlyMode() {
        return document.getElementById('hourly-mode').value; // "count" | "perMinute"
    }

    function ensureHoursSeries(list) {
        const byHour = new Map((list || []).map(o => [Number(o.hour), {
            count: Number(o.count || 0),
            perMinute: Number(o.avgPerMinute ?? (Number(o.count || 0) / 60))
        }]));
        const out = [];
        for (let h = 0; h <= 23; h++) {
            const v = byHour.get(h) || { count: 0, perMinute: 0 };
            out.push({ hour: h, count: v.count, perMinute: v.perMinute });
        }
        return out;
    }

    function updateHourlyKpis(rows) {
        const total = rows.reduce((a, r) => a + r.count, 0);
        const avgHour = (total / 24);
        let max = -1, maxH = 0;
        rows.forEach(r => { if (r.count > max) { max = r.count; maxH = r.hour; } });

        document.getElementById('kpi-total').textContent = total.toLocaleString('tr-TR');
        document.getElementById('kpi-avg-hour').textContent = Math.round(avgHour).toLocaleString('tr-TR');
        document.getElementById('kpi-peak-hour').textContent = `Pik: ${String(maxH).padStart(2,'0')}:00 (${max.toLocaleString('tr-TR')})`;
    }

    function renderHourlyTable(rows) {
        const tbody = document.getElementById('hourly-tbody');
        const mode = getHourlyMode();
        document.getElementById('hourly-col-title').textContent =
            mode === 'perMinute' ? 'Ortalama (dakika başına)' : 'Toplam (saatlik)';

        tbody.innerHTML = '';
        rows.forEach(r => {
            const val = mode === 'perMinute' ? r.perMinute : r.count;
            const tr = document.createElement('tr');
            const cls = val === 0 ? 'text-0' : '';
            tr.innerHTML = `
        <td class="${cls}">${String(r.hour).padStart(2, '0')}:00</td>
        <td class="text-end fw-semibold ${cls}">${mode === 'perMinute'
                ? val.toFixed(2)
                : val.toLocaleString('tr-TR')}</td>`;
            tbody.appendChild(tr);
        });
    }

    function barColors(rows, mode) {
        // En yüksek saati vurgula
        let max = -1, maxIdx = 0;
        rows.forEach((r, i) => { const v = mode === 'perMinute' ? r.perMinute : r.count; if (v > max) { max = v; maxIdx = i; } });
        return rows.map((r, i) => {
            const v = mode === 'perMinute' ? r.perMinute : r.count;
            if (v === 0) return 'rgba(0,0,0,0.08)';     // boş saatler
            return i === maxIdx ? 'rgba(13,110,253,0.9)' : 'rgba(13,110,253,0.45)'; // pik vurgulu
        });
    }

    function renderHourlyChart(rows) {
        const ctx = document.getElementById('hourly-chart');
        const labels = rows.map(r => String(r.hour).padStart(2, '0'));
        const mode = getHourlyMode();
        const series = rows.map(r => mode === 'perMinute' ? r.perMinute : r.count);

        // Günlük ortalama çizgisi (sabit değer)
        const avg = mode === 'perMinute'
            ? (rows.reduce((a, r) => a + r.perMinute, 0) / 24)
            : (rows.reduce((a, r) => a + r.count, 0) / 24);
        const avgLine = Array(24).fill(avg);

        if (hourlyChartInstance) hourlyChartInstance.destroy();

        hourlyChartInstance = new Chart(ctx, {
            data: {
                labels,
                datasets: [
                    {
                        type: 'bar',
                        label: mode === 'perMinute' ? 'Dak./Ortalama' : 'Saatlik Toplam',
                        data: series,
                        backgroundColor: barColors(rows, mode),
                        borderRadius: 6
                    },
                    {
                        type: 'line',
                        label: 'Günlük ortalama (saatlik)',
                        data: avgLine,
                        borderWidth: 2,
                        borderDash: [6,6],
                        pointRadius: 0,
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Saat' } },
                    y: { beginAtZero: true, title: { display: true, text: mode === 'perMinute' ? 'Adet / dakika' : 'Adet' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed.y;
                                return mode === 'perMinute' ? ` ${v.toFixed(2)} adet/dk` : ` ${v} adet`;
                            }
                        }
                    }
                }
            }
        });
    }

    function downloadHourlyCsv(rows, dateStr) {
        const mode = getHourlyMode();
        const header = `date,hour,${mode === 'perMinute' ? 'avg_per_minute' : 'count'}\n`;
        const lines = rows.map(r =>
            `${dateStr},${String(r.hour).padStart(2,'0')}:00,${mode === 'perMinute' ? r.perMinute.toFixed(2) : r.count}`
        ).join('\n');
        const csv = header + lines;
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `hourly_${dateStr}_${mode}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function loadHourly(dateStr) {
        const loading = document.getElementById('hourly-loading');
        const errorEl = document.getElementById('hourly-error');
        const wrap = document.getElementById('hourly-wrap');

        loading.classList.remove('d-none');
        errorEl.classList.add('d-none');
        wrap.classList.add('d-none');

        fetch(`/api/stats/hourly?date=${encodeURIComponent(dateStr)}`)
            .then(r => r.json())
            .then(list => {
                const rows = ensureHoursSeries(Array.isArray(list) ? list : []);
                lastHourlyRows = rows;
                updateHourlyKpis(rows);
                renderHourlyTable(rows);
                renderHourlyChart(rows);

                loading.classList.add('d-none');
                wrap.classList.remove('d-none');
            })
            .catch(err => {
                console.error(err);
                loading.classList.add('d-none');
                errorEl.classList.remove('d-none');
                errorEl.textContent = 'Saatlik veri alınamadı.';
            });
    }

    function initDailyPicker() {
        const input = document.getElementById('date-input');
        if (!input) return;
        input.value = toYMD(new Date()); // bugün
        loadDaily(input.value);
        loadHourly(input.value);
        input.addEventListener('change', () => {
            if (input.value) {
                loadDaily(input.value);
                loadHourly(input.value);
            }
        });
    }

    /* -------------------- INIT -------------------- */
    function refreshAll() {
        fetchPlcInfo();
        fetchLinesOverview();
    }

    document.addEventListener('DOMContentLoaded', function() {
        refreshAll();
        initDailyPicker();
        setInterval(refreshAll, REFRESH_MS);

        document.getElementById('hourly-mode').addEventListener('change', () => {
            if (!lastHourlyRows.length) return;
            renderHourlyTable(lastHourlyRows);
            renderHourlyChart(lastHourlyRows);
        });

        document.getElementById('hourly-download').addEventListener('click', () => {
            const input = document.getElementById('date-input');
            downloadHourlyCsv(lastHourlyRows, input?.value || toYMD(new Date()));
        });
    });
</script>
</body>
</html>
